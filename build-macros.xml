<project xmlns:ivy="antlib:org.apache.ivy.ant" name="macros">

  <!-- <once target="ant.task" marker="ant.property"/> -->
  <macrodef name="once">
    <attribute name="target"/>
    <attribute name="marker"/>
    <sequential>
      <antcall name="@{target}"/>
      <property name="@{marker}" value="[done]"/>
    </sequential>
  </macrodef>
    

  <!-- All-on-one publish task -->
  <!-- <publish-module ivy.file="ivy.xml" resolver="resolver.name"/> -->
  <macrodef name="publish-module">
   <attribute name="ivy.file"/>
   <attribute name="resolver" default="dev-publish"/>
   
   <sequential>
     <ivy:resolve file="@{ivy.file}"/>
     <ivy:publish conf="main" 
		  resolver="@{resolver}" 
		  overwrite="true"
		  forcedeliver="true">
       <artifacts pattern="${artifacts.dir}/[artifact]-[revision](-[classifier]).[ext]" />
     </ivy:publish>
   </sequential>
  </macrodef>


  <!-- Ivy resolve from an Ivy file -->
  <!-- <ivy-resolve-report ivy.file="ivy.xml"> -->
  <macrodef name="ivy-resolve-report">
    <attribute name="ivy.file"/>
    <sequential>
      <ivy:resolve conf="main"
		   haltonfailure="false" failureproperty="ivy.resolve.failed"/>
      <ivy:report todir="${reports.dir}"/>
      <fail message="Ivy dependency failed" if="ivy.resolve.failed"/>
    </sequential>
  </macrodef>


  <!-- Get the dependences from an Ivy file -->
  <!-- <ivy-setup-lib ivy.file="ivy.xml"> -->
  <macrodef name="ivy-setup-lib">
    <attribute name="ivy.file"/>
    <sequential>
      <ivy-resolve-report ivy.file="@{ivy.file}"/>
      <ivy:retrieve conf="dev" pattern="lib2/[artifact]-[revision](-[classifier]).[ext]" sync="true"/>
    </sequential>
  </macrodef>

  <target name="ivy-init">
    <ivy:settings />
  </target>

</project>